{% extends 'base.html' %}
{% load static %}
{% block title %}Detail Sesi Audit - {{ audit_session.program_studi.nama }} | Sistem Audit Mutu Internal{% endblock %}
{% block page_title %}Detail Sesi Audit{% endblock %}
{% block page_subtitle %}{{ audit_session.program_studi.nama }} ({{ audit_session.tahun_akademik }} Semester {{ audit_session.semester }}){% endblock %}
{% block mobile_title %}Detail Sesi Audit{% endblock %}
{% block content %}
<div class="p-4 lg:p-6">
    {% if messages %}
    <div class="mb-4 lg:mb-6">
        {% for message in messages %}
        <div class="p-3 mb-3 text-sm rounded-lg {{ message.tags|default:'bg-blue-50 text-blue-800' }}" role="alert">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-4 lg:mb-6">
        <div class="px-4 lg:px-6 py-4 border-b border-gray-200">
            <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Detail Sesi Audit</h3>
                    <p class="text-sm text-gray-500 mt-1">Status: 
                        <span class="px-2 py-1 rounded-full text-xs font-medium 
                            {% if audit_session.status == 'DRAFT' %}bg-gray-100 text-gray-800
                            {% elif audit_session.status == 'PENILAIAN_MANDIRI' %}bg-blue-100 text-blue-800
                            {% elif audit_session.status == 'PENILAIAN_AUDITOR' %}bg-purple-100 text-purple-800
                            {% elif audit_session.status == 'SELESAI' %}bg-green-100 text-green-800
                            {% endif %}">
                            {{ audit_session.get_status_display }}
                        </span>
                    </p>
                </div>
                <div class="mt-3 lg:mt-0 flex space-x-2">
                    {% if audit_session.status == 'PENILAIAN_MANDIRI' and user_program_studi == audit_session.program_studi %}
                    <form method="post" action="{% url 'ami:submit_penilaian_diri' audit_session.id %}">
                        {% csrf_token %}
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-paper-plane mr-2"></i> Kirim Penilaian Diri
                        </button>
                    </form>
                    {% endif %}
                    <a href="{% url 'ami:audit_session_update' audit_session.id %}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-edit mr-2"></i> Edit
                    </a>
                </div>
            </div>
        </div>
        <div class="p-4 lg:p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-medium text-gray-900 mb-2">Informasi Program Studi</h4>
                    <p><strong>Nama:</strong> {{ audit_session.program_studi.nama }}</p>
                    <p><strong>Fakultas:</strong> {{ audit_session.program_studi.fakultas }}</p>
                    <p><strong>Jenjang:</strong> {{ audit_session.program_studi.get_jenjang_display }}</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-medium text-gray-900 mb-2">Rentang Waktu</h4>
                    <p><strong>Penilaian Mandiri:</strong> 
                        {% if audit_session.tanggal_mulai_penilaian_mandiri and audit_session.tanggal_selesai_penilaian_mandiri %}
                            {{ audit_session.tanggal_mulai_penilaian_mandiri|date:"d M Y" }} - {{ audit_session.tanggal_selesai_penilaian_mandiri|date:"d M Y" }}
                        {% else %}
                            Tidak ditentukan
                        {% endif %}
                    </p>
                    <p><strong>Penilaian Auditor:</strong> 
                        {% if audit_session.tanggal_mulai_penilaian_auditor and audit_session.tanggal_selesai_penilaian_auditor %}
                            {{ audit_session.tanggal_mulai_penilaian_auditor|date:"d M Y" }} - {{ audit_session.tanggal_selesai_penilaian_auditor|date:"d M Y" }}
                        {% else %}
                            Tidak ditentukan
                        {% endif %}
                    </p>
                </div>
            </div>
            
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Penilaian Diri</h3>
            <div class="space-y-4">
               {% for penilaian in penilaian_diri %}
<div class="border rounded-lg p-4 hover:bg-gray-50 transition-colors">
    <div class="flex flex-col lg:flex-row lg:justify-between lg:items-start">
        <div class="lg:mr-4 mb-2 lg:mb-0">
            <h4 class="font-medium text-gray-900">{{ penilaian.elemen.kode }} - {{ penilaian.elemen.nama }}</h4>
            <p class="text-sm text-gray-500 mt-1">{{ penilaian.elemen.kriteria.nama }}</p>
            
            <!-- Tambahkan deskripsi dan panduan -->
            <div class="mt-3 bg-gray-50 p-3 rounded-md">
                <h5 class="font-medium text-gray-800 mb-1">Deskripsi:</h5>
                <p class="text-sm text-gray-700">{{ penilaian.elemen.deskripsi }}</p>
                
            </div>
            
            <div class="mt-3 flex flex-wrap items-center space-x-2">
                <span class="text-sm">
                    <span class="font-medium">Skor:</span> 
                    {% if penilaian.skor is not None %}
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm font-medium">
                        {{ penilaian.skor }} ({{ penilaian.skor|floatformat:2 }} dari {{ penilaian.elemen.skor_maksimal }})
                    </span>
                    {% else %}
                    <span class="text-gray-500">Belum diisi</span>
                    {% endif %}
                </span>
                {% if penilaian.bukti_dokumen %}
                <span class="text-sm">
                    <a href="{{ penilaian.bukti_dokumen }}" target="_blank" class="text-blue-600 hover:text-blue-800">
                        <i class="fas fa-file-alt mr-1"></i> Dokumen Pendukung
                    </a>
                </span>
                {% endif %}
                <span class="text-sm">
                    <span class="font-medium">Status:</span> 
                    {% if penilaian.status == 'DIAJUKAN' %}
                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-sm">Diajukan</span>
                    {% elif penilaian.status == 'TERISI' %}
                    <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-sm">Terisi</span>
                    {% else %}
                    <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-sm">Belum</span>
                    {% endif %}
                </span>
            </div>
            {% if penilaian.komentar %}
            <p class="text-sm text-gray-700 mt-2">
                <span class="font-medium">Komentar:</span> {{ penilaian.komentar }}
            </p>
            {% endif %}
        </div>
        <div class="flex space-x-2 mt-2 lg:mt-0">
            {% if audit_session.status == 'DRAFT' or audit_session.status == 'PENILAIAN_MANDIRI' %}
            <a href="{% url 'ami:penilaian_diri_update' penilaian.id %}" class="text-blue-600 hover:text-blue-900">
                <i class="fas fa-edit text-lg"></i>
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endfor %}
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="px-4 lg:px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Statistik Penilaian</h3>
        </div>
        <div class="p-4 lg:p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div>
                        <p class="text-sm text-gray-500">Total Elemen</p>
                        <p class="text-xl font-bold text-gray-900">{{ total_indikator }}</p>
                    </div>
                    <i class="fas fa-list text-2xl text-blue-500"></i>
                </div>
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div>
                        <p class="text-sm text-gray-500">Elemen Terisi</p>
                        <p class="text-xl font-bold text-gray-900">{{ indikator_terisi }}</p>
                    </div>
                    <i class="fas fa-check-circle text-2xl text-green-500"></i>
                </div>
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div>
                        <p class="text-sm text-gray-500">Persentase</p>
                        <p class="text-xl font-bold text-gray-900">{{ persentase_terisi|floatformat:1 }}%</p>
                    </div>
                    <i class="fas fa-chart-pie text-2xl text-purple-500"></i>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}