{% extends 'base.html' %}
{% load static custom_filters %}

{% block title %}Laporan Internal - {{ audit_session.program_studi.nama }} | AMI{% endblock %}
{% block page_title %}Laporan Internal{% endblock %}
{% block page_subtitle %}{{ audit_session.program_studi.nama }} ({{ audit_session.tahun_akademik }} Semester {{ audit_session.get_semester_display }}){% endblock %}
{% block mobile_title %}Laporan Internal{% endblock %}



{% block content %}
<style>
/* ====== Gaya Tampilan Kertas A4 ====== */
@media print {
  @page {
    size: A4;
    margin: 2cm;
  }
  body {
    background: white !important;
  }
  .bg-gray-50 {
    background-color: white !important;
  }
}

/* Preview kertas di layar */
.page {
  width: 21cm;
  min-height: 29.7cm;
  padding: 2cm;
  margin: 1cm auto;
  background: white;
  box-shadow: 0 0 5px rgba(0,0,0,0.1);
}

/* Untuk pemisah halaman berikutnya */
.page-break {
  page-break-before: always;
}

/* Teks formal */
.text-justify {
  text-align: justify;
}

/* Saat print hilangkan margin dan shadow */
@media print {
  .page {
    margin: 0;
    box-shadow: none;
    page-break-after: always;
  }
}
</style>

<!-- ====== sampul ====== -->
<div class="page">
  <h1 class="text-center font-extrabold text-2xl uppercase tracking-wide">
        LAPORAN AUDIT PROGRAM STUDI
      </h1>

      <h2 class="text-center font-semibold text-lg mt-2">
        ({{ audit_session.program_studi.jenjang|default:"D3/D4/S1/S2/S3" }})
        <span class="inline-block ml-1 align-bottom">
          {{ audit_session.program_studi.nama|default:"................................" }}
        </span>
      </h2>
      <br></br>
      <div class="h-12 md:h-16"></div>

      <div class="max-w-xl mx-auto">
        <table class="cover-table w-full text-sm border border-black">
          <tbody>
            <tr>
              <td class="w-1/2 px-3 py-2  decoration-2">Nama Program Studi</td>
              <td class="px-3 py-2">
                {{ audit_session.program_studi.nama|default:"..............................." }}
              </td>
            </tr>
            <tr>
              <td class="px-3 py-2  decoration-2">Fakultas</td>
              <td class="px-3 py-2">
                {% firstof audit_session.program_studi.fakultas.nama audit_session.program_studi.fakultas "..............................." %}
              </td>
            </tr>
            <tr>
              <td class="px-3 py-2  decoration-2">Tanggal Audit</td>
              <td class="px-3 py-2">
                {% if audit_session.tanggal_mulai_penilaian_mandiri or audit_session.tanggal_selesai_penilaian_auditor %}
                  {{ audit_session.tanggal_mulai_penilaian_mandiri|date:"d/m/Y" }} – {{ audit_session.tanggal_selesai_penilaian_auditor|date:"d/m/Y" }}
                {% else %}
                  ...............................
                {% endif %}
              </td>
            </tr>
            <tr>
              <td class="px-3 py-2  decoration-2">Ketua Auditor</td>
              <td class="px-3 py-2">
                {{ audit_session.auditor_ketua.nama_lengkap|default:"..............................." }}
              </td>
            </tr>
            <tr>
              <td class="px-3 py-2  decoration-2">Anggota Auditor</td>
              <td class="px-3 py-2">
                {% for a in audit_session.auditor_anggota.all %}
                  {{ a.nama_lengkap }}{% if not forloop.last %}, {% endif %}
                {% empty %}
                  ...............................
                {% endfor %}
              </td>
            </tr>
            <tr>
              <td class="px-3 py-2  decoration-2">Koordinator Program Studi</td>
              <td class="px-3 py-2">
                {{ koordinator_prodi.nama_lengkap|default:"..............................." }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>

        <br> </br>
        <br></br>
        

      <div class="flex justify-center my-8">
        <img src="/media/logountad.png" alt="Logo" class="h-20">

      </div>

      <br></br>
      <br></br>
      <br></br>
      <br></br>
      <div class="text-center font-extrabold uppercase leading-tight">
        <div>PUSAT PENJAMINAN MUTU INTERNAL (PPMI)</div>
        <div>LEMBAGA PENJAMINAN MUTU DAN PENGEMBANGAN PEMBELAJARAN (LPMPP)</div>
        <div>UNIVERSITAS TADULAKO</div>
      </div>
      <div class="text-center font-bold mt-3">
        {{ audit_session.tahun_akademik|default:"2025" }}
      </div>

    </div>

<!-- Halaman kedua -->
<div class="page page-break">
  <h1 class="text-center font-extrabold text-2xl uppercase tracking-wide">
       LAPORAN AUDIT INTERNAL
  </h1>
  <div class="h-12 md:h-16"></div>
  <!-- I. Informasi Umum -->
  <h2 class="section-title text-lg mb-3 font-bold">I.  Informasi Umum</h2>

  <table class="text-sm ml-4">
  <tbody>
    <tr>
      <td class="pr-4 ">Nama Program Studi</td>
      <td>: {{ audit_session.program_studi.nama }}</td>
    </tr>
    <tr>
      <td class="pr-4 ">Fakultas</td>
      <td>: {{ audit_session.program_studi.fakultas }}</td>
    </tr>
    <tr>
      <td class="pr-4">Tanggal Audit</td>
      <td>:
        {{ audit_session.tanggal_mulai_penilaian_mandiri|date:"d/m/Y" }}
        – {{ audit_session.tanggal_selesai_penilaian_auditor|date:"d/m/Y" }}
      </td>
    </tr>
    <tr>
      <td class="pr-4 ">Ketua Auditor</td>
      <td>: {{ audit_session.auditor_ketua.nama_lengkap }}</td>
    </tr>
    <tr>
      <td class="pr-4 ">Anggota Auditor</td>
      <td>:
        {% for a in audit_session.auditor_anggota.all %}
          {{ a.nama_lengkap }}{% if not forloop.last %}, {% endif %}
        {% empty %}...............................{% endfor %}
      </td>
    </tr>
    <tr>
      <td class="pr-4 ">Koordinator Program Studi</td>
      <td>: {{ koordinator_prodi.nama_lengkap|default:"..............................." }}</td>
    </tr>
  </tbody>
  </table>
  
  <div class="h-12 md:h-10"></div>

  <!-- II. Tujuan Audit -->
  <h2 class="section-title text-lg mb-2 font-bold">II. Tujuan Audit</h2>
  <ol class="list-[lower-alpha] pl-6 text-sm space-y-1 ml-4">
    <li>Memastikan pelaksanaan standar yang telah ditetapkan.</li>
    <li>Memastikan kesesuaian sistem manajemen dengan standar yang telah ditetapkan.</li>
    <li>Memastikan akuntabilitas dari pelaksanaan standar.</li>
    <li>Menentukan ruang lingkup, perbaikan, dan penguatan mutu Program Studi.</li>
    <li>Mengevaluasi efektivitas perencanaan, pelaksanaan, serta pengukuran mutu.</li>
    <li>Menetapkan kesiapan Program Studi dalam pelaksanaan program akreditasi.</li>
    <li>Menunjang kelancaran pelaksanaan pengelolaan Program Studi.</li>
  </ol>

  
  <div class="h-12 md:h-10"></div>

  <h2 class="section-title text-lg mb-3 font-bold">III. Ruang Lingkup Audit</h2>

{% with kode=audit_session.program_studi.lembaga_akreditasi.kode|upper %}
  {% if kode == "LAMTEKNIK" %}
    <table class="border border-black border-collapse text-sm ml-6 ">
      <thead class="bg-gray-50">
        <tr><th class="border border-black px-3 py-2 text-left">{{ audit_session.program_studi.lembaga_akreditasi.kode}}</th></tr>
      </thead>
      <tbody>
        <tr><td class="border border-black px-3 py-2">1. Mutu kepemimpinan dan kinerja tata kelola</td></tr>
        <tr><td class="border border-black px-3 py-2">2. Mutu dan produktivitas luaran (outputs) dan capaian (outcomes)</td></tr>
        <tr><td class="border border-black px-3 py-2">3. Mutu proses</td></tr>
        <tr><td class="border border-black px-3 py-2">4. Mutu input</td></tr>
        <tr><td class="border border-black px-3 py-2">5. Penjaminan mutu</td></tr>
        <tr><td class="border border-black px-3 py-2">6. Pengembangan berkelanjutan</td></tr>
        <tr><td class="border border-black px-3 py-2">7. Keterlibatan pemangku kepentingan</td></tr>

      </tbody>
    </table>

  {% elif kode == "LAMEMBA" %}
    <table class="border border-black border-collapse text-sm ml-6 ">
      <thead class="bg-gray-50">
        <tr><th class="border border-black px-3 py-2 text-left">{{ audit_session.program_studi.lembaga_akreditasi.kode}}</th></tr>
      </thead>
      <tbody>
        <tr><td class="border border-black px-3 py-2">1.	Visi, Misi, Tujuan, dan Strategi  </td></tr>
        <tr><td class="border border-black px-3 py-2">2.	Tata Pamong, Tata Kelola, dan Kerjasama </td></tr>
        <tr><td class="border border-black px-3 py-2">3.	Mahasiswa </td></tr>
        <tr><td class="border border-black px-3 py-2">4.	Sumber Daya Manusia </td></tr>
        <tr><td class="border border-black  px-3 py-2">5.	Keuangan, Sarana, dan Prasarana </td></tr>
        <tr><td class="border border-black px-3 py-2">6.	Kurikulum </td></tr>
        <tr><td class="border border-black px-3 py-2">7.	Penelitian </td></tr>
        <tr><td class="border border-black px-3 py-2">8.	Pengabdian pada Masyarakat </td></tr>
        <tr><td class="border border-black px-3 py-2">9.	Luaran dan Capaian Tridharma </td></tr>

      </tbody>
    </table>


  {% elif kode == "LAM-PTKes" %}
    <table class="border border-black border-collapse text-sm ml-6 ">
      <thead class="bg-gray-50">
        <tr><th class="border border-black px-3 py-2 text-left">{{ audit_session.program_studi.lembaga_akreditasi.kode}}</th></tr>
      </thead>
      <tbody>
        
        <tr><td class="border border-black px-3 py-2">1.	Visi, Misi, Tujuan, dan Strategi Pencapaian</td></tr>
        <tr><td class="border border-black px-3 py-2">2.	Tata Pamong, Kepemimpinan, Sistem Pengelolaan, dan Kerjasama</td></tr>
        <tr><td class="border border-black px-3 py-2">3.	Mahasiswa</td></tr>
        <tr><td class="border border-black px-3 py-2">4.	Sumber Daya Manusia</td></tr>
        <tr><td class="border border-black px-3 py-2">5.	Keuangan, Sarana, dan Prasarana</td></tr>
          <tr><td class="border border-black px-3 py-2">6.	Pendidikan</td></tr>
        <tr><td class="border border-black px-3 py-2">7.	Penelitian</td></tr>
        <tr><td class="border border-black px-3 py-2">8.	Pengabdian pada Masyarakat</td></tr>
        <tr><td class="border border-black px-3 py-2">9.	Luaran dan Capaian Tridharma</td></tr>

      </tbody>
    </table>  

  {% else %}
    <table class="border border-black border-collapse text-sm ml-6 ">
      <thead class="bg-gray-50">
        <tr><th class="border border-black px-3 py-2 text-left">{{ audit_session.program_studi.lembaga_akreditasi.kode}}</th></tr>
      </thead>
      <tbody>
        
        <tr><td class="border border-black px-3 py-2">1.  Visi, Misi, Tujuan, dan Strategi </td></tr>
        <tr><td class="border border-black px-3 py-2">2.	Tata Pamong, Tata Kelola, dan Kerjasama</td></tr>
        <tr><td class="border border-black px-3 py-2">3.	Mahasiswa</td></tr>
        <tr><td class="border border-black px-3 py-2">4.	Sumber Daya Manusia</td></tr>
        <tr><td class="border border-black px-3 py-2">5.	Keuangan, Sarana, dan Prasarana</td></tr>
        <tr><td class="border border-black px-3 py-2">6.	Pendidikan</td></tr>
        <tr><td class="border border-black px-3 py-2">7.	Penelitian</td></tr>
        <tr><td class="border border-black px-3 py-2">8.	Pengabdian pada Masyarakat</td></tr>
        <tr><td class="border border-black px-3 py-2">9.	Luaran dan Capaian Tridharma</td></tr>

      </tbody>
    </table>
  {% endif %}
{% endwith %}

</div>
<!-- Halaman Ketiga -->
<div class="page page-break">
  <!-- IV. Metodologi Audit -->
  <h2 class="section-title text-lg mb-2 font-bold">IV. Metodologi Audit</h2>

  <p class="text-sm ml-7 text-justify mr-4">Metode yang digunakan dalam pelaksanaan audit mutu internal melalui  observasi telaah dokumen dan visitasi dengan melakukan wawancara pada pimpinan UPPS, Koordinator Program Studi, mahasiswa, dosen dan tenaga kependidikan.  </p>
  <div class="h-12 md:h-10"></div>
    
  <!-- V. Hasil Audit -->
  <h2 class="section-title text-lg mb-2 font-bold">V. Hasil Audit</h2>
  <div>
  <table class="border border-black border-collapse text-sm ml-6 mr-4">
  <thead class="bg-gray-50">
    <tr>
      <th class="border border-black px-3 py-2 text-left">Aspek yang Dinilai</th>
      <th class="border border-black px-3 py-2 text-left">Kategori</th>
      <th class="border border-black px-3 py-2 text-left">Temuan Audit</th>
    </tr>
  </thead>
  <tbody>
  {% regroup audits by penilaian_diri.elemen.kriteria.nama as grouped %}
  {% for group in grouped %}
    <tr>
      <td class="border border-black px-3 py-2 align-top text-sm">
        <strong>{{ group.grouper }}</strong>
        <ol class="list-decimal ml-4">
          {% for x in group.list|dictsort:"penilaian_diri.elemen.kode" %}
            <li> {{ x.penilaian_diri.elemen.nama }}</li>
          {% endfor %}
        </ol>
      </td>
      <td class="border border-black px-3 py-2 align-top">
        <ol class="list-decimal ml-4">
          {% for x in group.list|dictsort:"penilaian_diri.elemen.kode" %}
            <li>{{ x.get_kategori_kondisi_display|default:"-" }}</li>
          {% endfor %}
        </ol>
      </td>
      <td class="border  border-black px-3 py-2 align-top">
        <ol class="list-decimal ml-4">
          {% for x in group.list|dictsort:"penilaian_diri.elemen.kode" %}
            <li>{{ x.deskripsi_kondisi|default:"-" }}</li>
          {% endfor %}
        </ol>
      </td>
    </tr>
      {% empty %}
        <tr>
          <td colspan="3" class="px-3 py-6 text-center text-gray-500">Belum ada hasil audit.</td>
        </tr>
       {% endfor %}
      </tbody>

      </table>
        <div class="h-5 md:h-5"></div>
        <p class="text-sm ml-7 text-justify mr-4">Keterangan : Jika pada Kolom Status Tidak Tercapai maka status KTS diberikan: KTS MINOR (ringan) adalah Ketidaksesuaian yang memiliki dampak terbatas terhadap sistem penjaminan mutu, KTS MAYOR (berat) adalah Ketidaksesuaian yang memiliki dampak luas terhadap sistem penjaminan mutu. Jika pada kolom status Tercapai namun dimungkinkan membutuhkan konfirmasi kinerja dan atau bukti link dokumen maka status OB  </p>
        <div class="h-5 md:h-5"></div>
    
    {# ======================= RADAR CHART — ELEMEN ======================= #}
<div class="chart-wrap no-break">
  <canvas id="radarChart"></canvas>
</div>


<script>
  
  const labels = {{ chart_labels_json|safe }};
  const scores = {{ chart_scores_json|safe }};

  if (Array.isArray(labels) && labels.length && Array.isArray(scores) && scores.length) {
    const ctx = document.getElementById('radarChart').getContext('2d');

    new Chart(ctx, {
      type: 'radar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Skor Audit per Elemen',
          data: scores,
          fill: true,
          backgroundColor: 'rgba(54, 162, 235, 0.20)',
          borderColor: 'rgb(54, 162, 235)',
          pointBackgroundColor: 'rgb(54, 162, 235)',
          borderWidth: 2,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false, 
        scales: {
          r: {
            beginAtZero: true,
            ticks: {
              stepSize: 1,   
              showLabelBackdrop: false
            },
            grid: { circular: true }
          }
        },
        plugins: {
          legend: { display: false },  
          tooltip: {
            callbacks: {
              label: (ctx) => ` ${ctx.formattedValue}`
            }
          }
        },
        elements: { line: { borderWidth: 2 } },
        animation: false 
      }
    });
  }
</script>

{# Narasi #}
<p class="mt-3 text-sm text-center">
  <em>Diagram Kekuatan dan Kelemahan Prodi {{ audit_session.program_studi.nama }}</em>
</p>
<p class="text-sm ml-7 text-justify mr-4">
  Hasil audit menunjukkan Prodi <strong>{{ audit_session.program_studi.nama }}</strong>
  memiliki <strong>kekuatan</strong> pada elemen <strong>{{ best_label }}</strong>,
  serta <strong>kelemahan</strong> pada elemen <strong>{{ worst_label }}</strong>.
</p>
{# ==================== /RADAR CHART — ELEMEN ==================== #}

</div>
<div class="h-12 md:h-10"></div>
<!-- VI. Kesimpulan -->
<h2 class="section-title text-lg mb-2 font-bold">VI. Kesimpulan</h2>

<p class="text-sm ml-7 text-justify mr-4">Tim Audit menyimpulkan:</p>

<ol class="list-decimal ml-11 text-justify text-sm mr-4">
  <li>
    Sistem dokumentasi yang ada di Prodi cukup efektif.
  Dari {{ total_dokumen_dibutuhkan }} jenis dokumen yang dibutuhkan, 
  hanya {{ belum_disipakan }} jenis dokumen (± {{ persen_belum }}%) yang belum disiapkan oleh Prodi.
  Untuk mendukung pelaksanaan SPMI diperlukan upaya untuk membangun sistem dokumentasi yang efektif,
  efisien, dan berkesinambungan.
  </li>
  <li>
    Temuan pada periode audit ini adalah:
  ({{ kategori_map.KT_MAYOR|default:"0" }}) (KTS Mayor),
  ({{ kategori_map.KT_MINOR|default:"0" }}) (KTS Minor),
  ({{ kategori_map.SESUAI|default:"0" }}) (OB).
  </li>
  <li>
    Prodi {{ audit_session.program_studi.nama }} memiliki <strong>kekuatan</strong> pada 
    <strong>{{ best_label }}</strong> dan <strong>kelemahan</strong> pada 
    <strong>{{ worst_label }}</strong>. Diharapkan pimpinan UPPS menindaklanjuti temuan dan rekomendasi
    AMI dengan menyusun rencana aksi serta mengalokasikan sumber daya yang diperlukan.
  </li>
</ol>
<div class="h-12 md:h-10"></div>
<!-- VII. Rencana Tindak Lanjut -->
  <h2 class="section-title text-lg mb-2 font-bold">VII. Rencana Tindak Lanjut</h2>
  <div>
  <table class="border border-black border-collapse text-sm ml-9 mr-4">
  <thead class="bg-gray-50">
    <tr>
      <th class="border border-black px-3 py-2 text-left">Aspek yang Dinilai</th>
      <th class="border border-black px-3 py-2 text-left">Temuan Audit</th>
      <th class="border border-black px-3 py-2 text-left">Status</th>
      <th class="border border-black px-3 py-2 text-left">Rencana Tindak Lanjut</th>
    </tr>
  </thead>
  <tbody>
  {% regroup audits by penilaian_diri.elemen.kriteria.nama as grouped %}
  {% for group in grouped %}
    <tr>
      <td class="border border-black px-3 py-2 align-top text-sm">
        <strong>{{ group.grouper }}</strong>
        <ol class="list-decimal ml-4">
          {% for x in group.list|dictsort:"penilaian_diri.elemen.kode" %}
            <li> {{ x.penilaian_diri.elemen.nama }}</li>
          {% endfor %}
        </ol>
      </td>
      
      <td class="border  border-black px-3 py-2 align-top">
        <ol class="list-decimal ml-4">
          {% for x in group.list|dictsort:"penilaian_diri.elemen.kode" %}
            <li>{{ x.deskripsi_kondisi|default:"-" }}</li>
          {% endfor %}
        </ol>
      </td>
      <td class="border  border-black px-3 py-2 align-top">
        <p>Sesuai/Tidak Sesuai</p>
      </td>
      <td class="border  border-black px-3 py-2 align-top">
        <p>1. </p>
        <p>2. </p>
        <p>dst. </p>
      </td>
    </tr>
      {% empty %}
        <tr>
          <td colspan="3" class="px-3 py-6 text-center text-gray-500">Belum ada hasil audit.</td>
        </tr>
       {% endfor %}
      </tbody>

      </table>
      <div class="h-12 md:h-10"></div>

      <!-- VIII. Pengesahan -->
       <h2 class="section-title text-lg mb-2 font-bold">VIII. Pengesahan</h2>
       <div class="mt-8 mx-12">
  <!-- Tanggal-->
  <p class="text-right mb-12">Palu, ....................... 2025</p>

  <div class="flex justify-between">
    <!-- Koordinator Prodi -->
    <div class="text-center">
      <p class="mb-24">Koordinator Program Studi</p>
      <p class="font-semibold underline">
        {{ koordinator_prodi.nama_lengkap|default:"........................" }}
      </p>
    </div>

    <!-- Ketua Auditor -->
    <div class="text-center">
      <p class="mb-24">Ketua Auditor</p>
      <p class="font-semibold underline">
        {{ audit_session.auditor_ketua.nama_lengkap|default:"........................" }}
      </p>
    </div>
  </div>
  </div>
</div>



</div>




{% endblock %}
